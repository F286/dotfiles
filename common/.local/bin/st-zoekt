#!/usr/bin/env bash
# st-zoekt â€” Interactive search over a local Zoekt index with ripgrep-style coloring.
# Usage: st-zoekt [--code] [PATH]

set -euo pipefail

code_mode=0
if [[ "${1:-}" == "--code" ]]; then
  code_mode=1
  shift
fi

root="${1:-$PWD}"
[[ -f "$root" ]] && root="$(dirname "$root")"
root="$(cd "$root" >/dev/null 2>&1 && pwd -P)"
index_dir="$root/.zoekt"

for cmd in zoekt fzf rg bat; do
  command -v "$cmd" >/dev/null 2>&1 || {
    echo "error: $cmd not found in PATH" >&2
    exit 1
  }
done

if [[ ! -d "$index_dir" ]]; then
  echo "error: no Zoekt index found at: $index_dir" >&2
  echo "hint: run 'si \"${root}\"' first to build the index." >&2
  exit 1
fi

# We output three colon-delimited fields for fzf:
#   1: raw path
#   2: raw line number
#   3: pretty display (colored "path:line[:col]: text" with rg match highlights)
#
# Notes:
# - We keep ripgrep in the pipeline for match highlighting.
# - Then awk rebuilds a pretty, colored prefix for path/line/(col), while preserving rg's highlights in the text.
# - fzf shows only field 3 (with-nth=3..), but uses {1} and {2} (raw) in bindings and preview.

reload_cmd="zoekt -index_dir '$index_dir' -- {q} \
  | rg --passthru --smart-case --color=always -- {q} \
  | awk 'BEGIN{
      FS=\":\"; OFS=\":\";
      mag=\"\\033[38;2;106;153;85m\";   # filename color
      gre=\"\\033[32m\";                # line/col color
      rst=\"\\033[0m\";
    }
    {
      p=\$1; l=\$2; rest=\$0;
      gsub(/\033\[[0-9;]*m/, \"\", p);

      if (\$3 ~ /^[0-9]+$/) {
        c=\$3;
        sub(/^[^:]*:[^:]*:[^:]*:/, \"\", rest);
        pretty = mag p rst \" \" gre l rst \" \" gre c rst \" \" rest;
      } else {
        sub(/^[^:]*:[^:]*:/, \"\", rest);
        pretty = mag p rst \"   \" rst \"   \" rest;
      }
      print p, l, pretty;
    }'"

# Replace {root} placeholders in additional args
for i in "${!ADDITIONAL_ARGS[@]}"; do
  ADDITIONAL_ARGS[i]="${ADDITIONAL_ARGS[i]//\{root\}/$root}"
done

exec fzf \
  --ansi \
  --tiebreak=index \
  --disabled \
  --delimiter : \
  --with-nth=3.. \
  --bind "start:reload:${reload_cmd} || true" \
  --bind "change:reload:${reload_cmd} || true" \
  --preview "cd '$root' && bat --style=numbers --color=always {2} {1}" \
  --preview-window 'bottom,30%,+{2}/2' \
  "${ADDITIONAL_ARGS[@]}"
