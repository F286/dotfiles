#!/usr/bin/env bash
set -euo pipefail

# Use Git index when available (fast), else fd -> rg -> find
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  SRC_CMD=(git -c core.quotepath=false ls-files -co --exclude-standard)
elif command -v fd >/dev/null 2>&1; then
  SRC_CMD=(fd --type f --hidden --follow --exclude .git)
elif command -v rg >/dev/null 2>&1; then
  SRC_CMD=(rg --files --hidden --follow -g '!.git')
else
  SRC_CMD=(find . -type f)
fi

# Preview (bat if present, else head)
PREVIEW='bat --style=numbers --color=always -- {} 2>/dev/null || head -n 200 -- {}'

# Run fzf (multi-select supported)
# We do NOT use arithmetic or history expansion; this runs in bash
SEL="$("${SRC_CMD[@]}" | fzf --prompt='Files ï€‚  ' \
  --preview "$PREVIEW" --preview-window=right,60%,border,hidden \
  --multi || true)"

# Open the selected files in VS Code (preferred)
if [[ -n "${SEL:-}" ]]; then
  mapfile -t ITEMS < <(printf '%s\n' "$SEL")
  if command -v code >/dev/null 2>&1; then
    code -r -- "${ITEMS[@]}"
  else
    # Fallback to $VISUAL / $EDITOR if code isn't installed
    "${VISUAL:-${EDITOR:-vi}}" "${ITEMS[@]}"
  fi
fi
exit 0
