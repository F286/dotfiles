#!/usr/bin/env bash
set -euo pipefail

# Initial query can be passed as arguments, e.g. vt "todo:"
QUERY="${*:-}"

# ripgrep base (hidden files, respect .gitignore; exclude .git)
RG_PREFIX=(rg --column --line-number --no-heading --smart-case --hidden -g '!.git' --color=always)

# Build fzf command. We avoid zsh arithmetic and history expansion entirely.
SEL="$(
  fzf --ansi --disabled --prompt='RG   ' \
      --bind "start:reload:printf ''" \
      --bind "change:reload:${RG_PREFIX[*]} {q} || true" \
      --delimiter ':' \
      --preview 'if [ -n "{1}" ]; then (bat --style=numbers --color=always --line-range {2}: -- {1} 2>/dev/null || (tail -n +{2} -- {1} 2>/dev/null | head -n 200)); else (bat --style=numbers --color=always -- {1} 2>/dev/null || head -n 200 -- {1}); fi' \
      --preview-window=right,60%,border,hidden \
      --query "$QUERY" \
      || true
)"

# Open selected match in Code at the proper line
if [[ -n "${SEL:-}" ]]; then
  FILE="${SEL%%:*}"; REST="${SEL#*:}"
  LINE="${REST%%:*}"
  if command -v code >/dev/null 2>&1; then
    if [[ -n "$LINE" ]]; then code -r --goto "$FILE:$LINE"; else code -r -- "$FILE"; fi
  else
    "${VISUAL:-${EDITOR:-vi}}" "+${LINE:-1}" "$FILE"
  fi
fi
exit 0
