#!/usr/bin/env bash
set -euo pipefail

QUERY="${*:-}"
RG_PREFIX=(rg --column --line-number --no-heading --smart-case --hidden -g '!.git' --color=always)

SEL="$(
  fzf --ansi --disabled --prompt='RG   ' \
    --bind "start:reload:printf ''" \
    --bind "change:reload:${RG_PREFIX[*]} {q} || true" \
    --delimiter ':' \
    --preview 'if [ -n "{1}" ]; then (bat --style=numbers --color=always --line-range {2}: -- {1} 2>/dev/null || (tail -n +{2} -- {1} 2>/dev/null | head -n 200)); else (bat --style=numbers --color=always -- {1} 2>/dev/null || head -n 200 -- {1}); fi' \
    --preview-window=right,60%,border \
    --bind 'alt-p:toggle-preview' \
    --query "$QUERY" ||
    true
)"

if [ -n "${SEL:-}" ]; then
  file="${SEL%%:*}"
  rest="${SEL#*:}"
  line="${rest%%:*}"
  if command -v code >/dev/null 2>&1; then
    [ -n "$line" ] && code -r --goto "$file:$line" || code -r -- "$file"
  else
    "${VISUAL:-${EDITOR:-vi}}" "+${line:-1}" "$file"
  fi
fi
exit 0
