#!/usr/bin/env bash
set -euo pipefail

QUERY="${*:-}"

# 1) Start from project root (like LazyVim/Telescope)
if git rev-parse --show-toplevel >/dev/null 2>&1; then
  cd "$(git rev-parse --show-toplevel)"
fi

# 2) Build the file list (prefer Git index for speed)
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  SRC_CMD=(git -c core.quotepath=false ls-files -co --exclude-standard)
elif command -v fd >/dev/null 2>&1; then
  SRC_CMD=(fd --type f --hidden --follow --exclude .git)
elif command -v rg >/dev/null 2>&1; then
  SRC_CMD=(rg --files --hidden --follow -g '!.git')
else
  SRC_CMD=(find . -type f)
fi

# 3) Preview: show the WHOLE file (no filtering), syntax‑highlight if bat exists
if command -v bat >/dev/null 2>&1; then
  # --style=full keeps header, grid and numbers -> very close to LazyVim preview
  PREVIEW_CMD='bat --style=full --color=always --paging=never -- {} 2>/dev/null || head -n 300 -- {}'
else
  PREVIEW_CMD='head -n 300 -- {}'
fi

# 4) fzf UI/behavior (TokyoNight theme comes from your FZF_DEFAULT_OPTS)
#    - Preview on the RIGHT
#    - Alt‑P toggles preview
#    - Enter opens selection(s) and closes picker
"${SRC_CMD[@]}" | FZF_DEFAULT_OPTS="${FZF_DEFAULT_OPTS-}" \
  fzf --ansi \
  --prompt='Files   ' \
  --preview "$PREVIEW_CMD" \
  --preview-window=right,60%,border \
  --bind 'alt-p:toggle-preview,enter:execute-silent(code -r -- {+})+abort' \
  --multi \
  --query "$QUERY" ||
  true
