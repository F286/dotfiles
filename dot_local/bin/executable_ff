#!/usr/bin/env bash
set -euo pipefail

QUERY="${*:-}"

# Source list: prefer Git index (fast), else fd -> rg -> find
if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  SRC_CMD=(git -c core.quotepath=false ls-files -co --exclude-standard)
elif command -v fd >/dev/null 2>&1; then
  SRC_CMD=(fd --type f --hidden --follow --exclude .git)
elif command -v rg >/dev/null 2>&1; then
  SRC_CMD=(rg --files --hidden --follow -g '!.git')
else
  SRC_CMD=(find . -type f)
fi

# Preview:
# - With a query -> show WHOLE file, just highlight matches (no filtering)
# - Without a query -> show syntax-highlighted head
if command -v rg >/dev/null 2>&1; then
  PREVIEW_WITH_QUERY='rg --passthru --color=always --line-number --no-heading --smart-case -- {q} {}'
else
  PREVIEW_WITH_QUERY='cat {}'
fi
if command -v bat >/dev/null 2>&1; then
  PREVIEW_NO_QUERY='bat --style=numbers --color=always -- {} 2>/dev/null || head -n 200 -- {}'
else
  PREVIEW_NO_QUERY='head -n 200 -- {}'
fi

"${SRC_CMD[@]}" | FZF_DEFAULT_OPTS="${FZF_DEFAULT_OPTS-}" \
  fzf --ansi \
  --prompt='Files ï€‚  ' \
  --preview 'if [ -n "{q}" ]; then '"$PREVIEW_WITH_QUERY"'; else '"$PREVIEW_NO_QUERY"'; fi' \
  --preview-window=right,60%,border \
  --bind 'alt-p:toggle-preview,enter:execute-silent(code -r -- {+})+abort' \
  --multi \
  --query "$QUERY" ||
  true
